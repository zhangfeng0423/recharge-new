#!/usr/bin/env node

/**
 * Sync Local Environment Variables to Vercel
 *
 * This script reads environment variables from .env.local
 * and exports them to Vercel using the Vercel CLI.
 *
 * Usage: node scripts/sync-env-to-vercel.js
 */

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

// Environment variables to sync (exclude sensitive ones)
const ENV_VARS_TO_SYNC = [
  'NEXT_PUBLIC_SUPABASE_URL',
  'NEXT_PUBLIC_SUPABASE_ANON_KEY',
  'SUPABASE_SERVICE_ROLE_KEY',
  'SUPABASE_POOLER_URL',
  'NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY',
  'STRIPE_SECRET_KEY',
  'NEXT_PUBLIC_APP_URL',
  'DEFAULT_LOCALE',
  'SUPPORTED_LOCALES',
  'NODE_ENV',
  'JWT_SECRET',
  'CORS_ORIGINS',
  'RATE_LIMIT_PER_MINUTE',
  'MAX_FILE_SIZE',
];

// Read and parse .env.local file
function readEnvFile(filePath) {
  try {
    const content = fs.readFileSync(filePath, 'utf8');
    const envVars = {};

    content.split('\n').forEach(line => {
      // Skip comments and empty lines
      if (line.trim() === '' || line.trim().startsWith('#')) {
        return;
      }

      const match = line.match(/^([^=]+)=(.*)$/);
      if (match) {
        const key = match[1].trim();
        const value = match[2].trim();

        // Remove quotes if present
        const cleanValue = value.replace(/^["']|["']$/g, '');
        envVars[key] = cleanValue;
      }
    });

    return envVars;
  } catch (error) {
    console.error(`Error reading ${filePath}:`, error.message);
    return {};
  }
}

// Check if Vercel CLI is installed
function checkVercelCLI() {
  try {
    execSync('vercel --version', { stdio: 'pipe' });
    return true;
  } catch (error) {
    console.error('‚ùå Vercel CLI is not installed.');
    console.error('Please install it with: npm i -g vercel');
    return false;
  }
}

// Export environment variables to Vercel
function exportToVercel(envVars, environment = 'production') {
  const envType = environment === 'production' ? 'production' : 'preview';
  let exportedCount = 0;

  console.log(`\nüöÄ Exporting environment variables to Vercel (${envType})...`);
  console.log('=' .repeat(60));

  for (const key of ENV_VARS_TO_SYNC) {
    if (envVars[key]) {
      try {
        // Check if variable already exists
        try {
          const currentResult = execSync(`vercel env ls ${key} ${envType}`, {
            encoding: 'utf8',
            stdio: 'pipe'
          });

          // Variable exists, update it
          execSync(`vercel env rm ${key} ${envType}`, { stdio: 'pipe' });
          execSync(`vercel env add ${key} ${envType}`, {
            input: envVars[key],
            stdio: 'pipe'
          });
          console.log(`‚úÖ Updated: ${key}`);
        } catch (error) {
          // Variable doesn't exist, create it
          execSync(`vercel env add ${key} ${envType}`, {
            input: envVars[key],
            stdio: 'pipe'
          });
          console.log(`‚úÖ Created: ${key}`);
        }

        exportedCount++;
      } catch (error) {
        console.error(`‚ùå Failed to export ${key}:`, error.message);
      }
    } else {
      console.log(`‚ö†Ô∏è  Skipping: ${key} (not found in .env.local)`);
    }
  }

  console.log('=' .repeat(60));
  console.log(`‚úÖ Successfully exported ${exportedCount} environment variables`);
}

// Create a .vercel.env file for reference
function createVercelEnvFile(envVars, environment = 'production') {
  const envType = environment === 'production' ? 'Production' : 'Preview/Development';
  let content = `# Game Recharge Platform - Vercel Environment Variables (${envType})
# Generated by sync-env-to-vercel.js
# Date: ${new Date().toISOString()}

`;

  for (const key of ENV_VARS_TO_SYNC) {
    if (envVars[key]) {
      content += `${key}=${envVars[key]}\n`;
    }
  }

  // Add special notes
  content += `

# ‚ö†Ô∏è  IMPORTANT MANUAL SETUP REQUIRED:
# 1. STRIPE_WEBHOOK_SECRET - Get from Stripe Dashboard > Developers > Webhooks
#    Endpoint URL: https://your-domain.vercel.app/api/webhooks/stripe
#    Events: checkout.session.completed, checkout.session.expired,
#            payment_intent.succeeded, payment_intent.payment_failed,
#            payment_intent.canceled

# 2. Update NEXT_PUBLIC_APP_URL for production:
#    Should be: https://your-domain.vercel.app

# 3. Update CORS_ORIGINS for production:
#    Should be: https://your-domain.vercel.app
`;

  const fileName = `.vercel.env.${environment}`;
  fs.writeFileSync(fileName, content);
  console.log(`üìù Created reference file: ${fileName}`);
}

// Main execution
function main() {
  console.log('üîß Game Recharge Platform - Environment Variables Sync Tool');
  console.log('=' .repeat(60));

  // Check if Vercel CLI is available
  if (!checkVercelCLI()) {
    process.exit(1);
  }

  // Read local environment variables
  const envPath = path.join(__dirname, '../.env.local');
  const envVars = readEnvFile(envPath);

  if (Object.keys(envVars).length === 0) {
    console.error('‚ùå No environment variables found in .env.local');
    process.exit(1);
  }

  console.log(`üìñ Found ${Object.keys(envVars).length} environment variables in .env.local`);

  // Ask user to confirm
  const readline = require('readline');
  const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout
  });

  rl.question('\nü§î Do you want to export to (1) Production, (2) Preview/Development, or (3) Both? [1-3]: ', (answer) => {
    rl.close();

    const choice = answer.trim();

    if (choice === '1') {
      exportToVercel(envVars, 'production');
      createVercelEnvFile(envVars, 'production');
    } else if (choice === '2') {
      exportToVercel(envVars, 'preview');
      createVercelEnvFile(envVars, 'preview');
    } else if (choice === '3') {
      console.log('\nüîÑ Exporting to both environments...');
      exportToVercel(envVars, 'production');
      exportToVercel(envVars, 'preview');
      createVercelEnvFile(envVars, 'production');
      createVercelEnvFile(envVars, 'preview');
    } else {
      console.error('‚ùå Invalid choice. Please run the script again.');
      process.exit(1);
    }

    console.log('\nüéâ Environment variables sync completed!');
    console.log('\nüìã Next Steps:');
    console.log('1. Check your Vercel Dashboard for the environment variables');
    console.log('2. Manually add STRIPE_WEBHOOK_SECRET (see .vercel.env file for instructions)');
    console.log('3. Trigger a new deployment on Vercel');
    console.log('4. Test your application at the deployed URL');
  });
}

// Run the script
if (require.main === module) {
  main();
}